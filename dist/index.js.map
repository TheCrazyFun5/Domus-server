{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"AAAA,OAAO,OAAO,MAAM,SAAS,CAAC;AAC9B,OAAO,MAAM,MAAM,0BAA0B,CAAC;AAC9C,OAAO,YAAY,MAAM,gCAAgC,CAAC;AAC1D,OAAO,YAAY,MAAM,eAAe,CAAC;AACzC,OAAO,IAAI,MAAM,MAAM,CAAC;AACxB,+BAA+B;AAE/B,IAAI,MAAW,CAAC;AAChB,IAAI,WAAW,GAAG,IAAI,GAAG,EAAO,CAAC;AAEjC,IAAI,YAGH,CAAC;AAEF,KAAK,UAAU,eAAe;IAC5B,MAAM,QAAQ,GAAG,OAAO,EAAE,CAAC;IAC3B,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,EAAE,CAAC,CAAC;IAC7B,QAAQ,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC,CAAC;IAC7B,QAAQ,CAAC,GAAG,CACV,IAAI,CAAC;QACH,MAAM,EAAE,uBAAuB;QAC/B,WAAW,EAAE,IAAI;KAClB,CAAC,CACH,CAAC;IACF,IAAI,YAAY,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC;QAC7B,YAAY,GAAG;YACb,EAAE,EAAE,SAAS;YACb,IAAI,EAAE,YAAY,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI;SAC3C,CAAC;QACF,MAAM,EAAE,GAAG,CAAC,MAAM,MAAM,CAAC,sBAAsB,CAAC,CAAC,CAAC,UAAU,CAAC;QAC7D,MAAM,GAAG,GAAG,CAAC,MAAM,MAAM,CAAC,cAAc,CAAC,CAAC,CAAC,GAAG,CAAC;QAC/C,MAAM,EAAE,EAAE,CAAC;QAEX,QAAQ,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;IACpB,CAAC;SAAM,CAAC;QACN,MAAM,CAAC,GAAG,CAAC,IAAI,CAAC,2CAA2C,EAAE,WAAW,CAAC,CAAC;QAC1E,MAAM,SAAS,GAAG,CAAC,MAAM,MAAM,CAAC,sBAAsB,CAAC,CAAC,CAAC,OAAO,CAAC;QACjE,YAAY,GAAG;YACb,EAAE,EAAE,SAAS;YACb,IAAI,EAAE,IAAI;SACX,CAAC;QACF,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC,CAAC;IACtC,CAAC;IACD,MAAM,GAAG,QAAQ,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,EAAE,YAAY,CAAC,EAAE,EAAE,GAAG,EAAE;QAChE,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,yCAAyC,YAAY,CAAC,IAAI,EAAE,CAAC,CAAC;IAC/E,CAAC,CAAC,CAAC;IACH,MAAM,CAAC,EAAE,CAAC,YAAY,EAAE,CAAC,MAAW,EAAE,EAAE;QACtC,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;QACxB,MAAM,CAAC,EAAE,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,CAAC;IACvD,CAAC,CAAC,CAAC;AACL,CAAC;AACD,SAAS,UAAU;IACjB,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;IACxC,KAAK,MAAM,MAAM,IAAI,WAAW,EAAE,CAAC;QACjC,MAAM,CAAC,OAAO,EAAE,CAAC;IACnB,CAAC;IACD,WAAW,CAAC,KAAK,EAAE,CAAC;IACpB,IAAI,MAAM,EAAE,CAAC;QACX,MAAM,CAAC,KAAK,CAAC,GAAG,EAAE;YAChB,MAAM,CAAC,GAAG,CAAC,GAAG,CAAC,6BAA6B,CAAC,CAAC;YAC9C,UAAU,CAAC,GAAG,EAAE,CAAC,eAAe,EAAE,EAAE,IAAI,CAAC,CAAC;QAC5C,CAAC,CAAC,CAAC;IACL,CAAC;AACH,CAAC;AACD,eAAe,EAAE,CAAC","sourcesContent":["import express from \"express\";\r\nimport logger from \"./module/logger/index.js\";\r\nimport configLoader from \"./module/configLoader/index.js\";\r\nimport cookieParser from \"cookie-parser\";\r\nimport cors from \"cors\";\r\n// import crypto from \"crypto\";\r\n\r\nlet server: any;\r\nlet connections = new Set<any>();\r\n\r\nlet configServer!: {\r\n  ip: string;\r\n  port: number;\r\n};\r\n\r\nasync function startupSnapshot() {\r\n  const appStart = express();\r\n  appStart.use(express.json());\r\n  appStart.use(cookieParser());\r\n  appStart.use(\r\n    cors({\r\n      origin: \"http://localhost:5173\",\r\n      credentials: true,\r\n    })\r\n  );\r\n  if (configLoader.main.config) {\r\n    configServer = {\r\n      ip: \"0.0.0.0\",\r\n      port: configLoader.main.config.Server.port,\r\n    };\r\n    const db = (await import(\"./module/BD/index.js\")).connection;\r\n    const app = (await import(\"./app/app.js\")).app;\r\n    await db();\r\n\r\n    appStart.use(app);\r\n  } else {\r\n    logger.app.warn(\"🛠 Конфиг не найден, запускаем установщик\", \"Installer\");\r\n    const installer = (await import(\"./installer/index.js\")).default;\r\n    configServer = {\r\n      ip: \"0.0.0.0\",\r\n      port: 2302,\r\n    };\r\n    appStart.use(installer(restartApp));\r\n  }\r\n  server = appStart.listen(configServer.port, configServer.ip, () => {\r\n    logger.app.log(`🚀 Сервер запущен на http://localhost:${configServer.port}`);\r\n  });\r\n  server.on(\"connection\", (socket: any) => {\r\n    connections.add(socket);\r\n    socket.on(\"close\", () => connections.delete(socket));\r\n  });\r\n}\r\nfunction restartApp(): void {\r\n  logger.app.log(\"Перезапуск сервера...\");\r\n  for (const socket of connections) {\r\n    socket.destroy();\r\n  }\r\n  connections.clear();\r\n  if (server) {\r\n    server.close(() => {\r\n      logger.app.log(\"🔴 Старый сервер остановлен\");\r\n      setTimeout(() => startupSnapshot(), 2000);\r\n    });\r\n  }\r\n}\r\nstartupSnapshot();\r\n"]}